# Тестовое задание по бэкенду в karpov.courses

## Задача
Необходимо создать асинхронный API для сервиса запуска аналитических экспериментов.
Данные из csv файлов должны храниться в базе данных и подгружаться по необходимости.

## Описание
Я реализовывал API на django rest framework. Эндпоинты реализованы двумя вариантами: через viewset и api_view. Базу
данных я подгружал через кастомные команды loadsales и loaddetails. Они построчно считывают csv файл и создают объекты 
нужной модели в БД. Необычным требованием для меня было реализовать один эндпоинт, принимающий в query_params тип 
объекта, которые нужно выводить. Я сделал мапу, сопоставляющую строку с названием класса и самой моделью. То же самое и 
для сериалайзеров. Мапа создается отдельных функциях в utils через модуль inspect. Вместо вручную заданной мапы я сделал
функции, которые, анализируя models.py и serializers.py, сопоставляет строку всем классам из этих модулей. Это сделано 
для того, чтобы, в случае необходимости в расширении API и добоваления новых моделей и сериалайзеров, не пришлось 
переписывать views.py. Далее я использовал воркер celery и брокер redis для реализации выполнения "длинных" тасков. В 
приложении api в модуле tasks.py требуемая функция calculate_metric и допольнительная функция update_sent_state. 
Последняя нужна для того, чтобы разделять состояния PENDING и SENT, т. к. в celery как отправленные процессы, так и 
несуществующие помечаются татусом PENDING. Также я хотел использовать docker, но это новая для меня технолгия, раньше не
 приходилось в ней работать.

## Запуск
1) Нужно установить python, redis, celery, postgres и postgres-client-common 
2) Склонировать проект: git clone
3) Скачать необходимые модули: pip install -r requirements.txt
4) В bash заресторить базу данных (если не сработало, просто создать базу данных с названием test_task и в файле .env
   указать логин и пароль своего юзера и в юрле бд (или просто заменить бд на sqlite))
5) В bash запустить брокер redis: redis-server
6) В новом терминале bash запустить воркер celery: celery -A TestTask worker -loglevel=info
7) Запустить сервер django: python manage.py runserver

## Работа
Реализован эндпоинт /logs. Обязательным для работы query_param`ом является table_name. Может быть Sale или Detail. Также
опционально могут быть параметры from_date и user_id. При наличии они будут должным образом сортировать вывод из 
заданной таблицы.
Также есть эндпоинт /launch, который запускает "сожный математический процесс" на сервере и возвращает id, который этому 
таску выдал celery.
Эндпоинт /get_result принимает в query_params id таски, чей статус и результат мы хотим проверить. В зависимости от 
состояния возвращает статус и, если имеется, результат вычислений.
